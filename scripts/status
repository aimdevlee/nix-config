#!/usr/bin/env bash

echo "ðŸ“Š Nix-Darwin System Status"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Current user and expected profile
CURRENT_USER="$(whoami)"
case "$CURRENT_USER" in
    "aimdevlee")
        EXPECTED_PROFILE="personal"
        ;;
    "dongbin-lee")
        EXPECTED_PROFILE="work"
        ;;
    *)
        EXPECTED_PROFILE="unknown"
        ;;
esac

echo "ðŸ‘¤ Current User: $CURRENT_USER"
echo "ðŸ“ Expected Profile: $EXPECTED_PROFILE"
echo ""

# System information
echo "ðŸ’» System Information:"
echo "   Platform: $(uname -s) $(uname -m)"
echo "   OS Version: $(sw_vers -productVersion)"
echo "   Hostname: $(hostname)"
echo ""

# Nix information
echo "â„ï¸  Nix Information:"
echo "   Nix Version: $(nix --version | head -1)"
if [ -L /run/current-system ]; then
    echo "   Current System: $(readlink /run/current-system | xargs basename)"
    LAST_MODIFIED=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" /run/current-system 2>/dev/null || echo "Unknown")
    echo "   Last Switch: $LAST_MODIFIED"
else
    echo "   âš ï¸  No darwin-rebuild system found"
fi
echo ""

# Git status
echo "ðŸ“ Repository Status:"
cd "$(dirname "$0")/.." || exit
if git rev-parse --git-dir > /dev/null 2>&1; then
    BRANCH=$(git branch --show-current)
    DIRTY=$(git status --porcelain | wc -l | xargs)
    LAST_COMMIT=$(git log -1 --format="%h %s" 2>/dev/null)

    echo "   Branch: $BRANCH"
    echo "   Dirty Files: $DIRTY"
    echo "   Last Commit: $LAST_COMMIT"
else
    echo "   Not a git repository"
fi
echo ""

# Flake information
echo "ðŸ”§ Flake Outputs:"
if [ -f flake.nix ]; then
    echo "   Available Profiles:"
    # Simple grep for darwinConfigurations instead of full evaluation
    grep -E "^\s*(personal|work|dev)" flake.nix | grep "=" | awk '{print $1}' | sed 's/^/      - /' || echo "      - personal"$'\n'"      - work"
else
    echo "   No flake.nix found"
fi
echo ""

# Quick checks
echo "âœ… Quick Checks:"

# Check if current profile matches expected
if [ -L /run/current-system ]; then
    CURRENT_PROFILE=$(readlink /run/current-system | grep -o 'darwin-system-.*' | head -1)
    echo -n "   Profile Match: "
    if [[ "$CURRENT_PROFILE" == *"$EXPECTED_PROFILE"* ]] || [ "$EXPECTED_PROFILE" == "unknown" ]; then
        echo "âœ“"
    else
        echo "âœ— (May need to rebuild with correct profile)"
    fi
fi

# Check if Homebrew is installed
echo -n "   Homebrew: "
if command -v brew >/dev/null 2>&1; then
    echo "âœ“ ($(brew --version | head -1))"
else
    echo "âœ—"
fi

# Check if direnv is active
echo -n "   Direnv: "
if [ -n "$DIRENV_DIR" ]; then
    echo "âœ“ (Active in this directory)"
elif command -v direnv >/dev/null 2>&1; then
    echo "âœ“ (Installed but not active here)"
else
    echo "âœ—"
fi

echo ""
echo "ðŸ’¡ Tip: Run 'rebuild' to apply configuration for your profile"